---
	import { Certificates, Education, Work } from '@/lib';
	import { Image } from 'astro:assets';
	import { format, parseISO } from 'date-fns';

	type TimelineItemType = Work | Education | Certificates;

	interface Props {
		experiences: {
			image: string;
			startDate?: string;
			endDate?: string;
			date?: string;
			eventDate?: string;
			name?: string;
			institution?: string;
			position?: string;
			issuer?: string;
			area?: string;
			summary?: string;
			useSummary?: boolean;
			highlights?: string[];
			studyType?: string;
		}[];
		type: TimelineItemType;
	}

	const {
		experiences,
		type,
	} = Astro.props;

	const Logo = (image: string) => {
		return Object.entries(
			import.meta.glob('@/images/*.{png,jpg}', {
				eager: true,
				query: '?url',
				import: 'default',
			}),
		)
			.reduce(
				(prev, [key, value]) => ({
					...prev,
					[key.substring(key.indexOf(image))]: value as string,
				}),
				{} as Record<string, string>,
			)[image];
	};
---

{type.heading &&
	<h2
		id="{type.heading.id}-title"
		class="timeline__section-heading"
	>
		{type.heading.title}
	</h2> ||
	<h2 class="timeline__section-heading" data-sr-only>
		Experience
	</h2>
}
<div class="timeline" data-type={type.experience}> {
	experiences.map(({
		startDate,
		endDate,
		date,
		eventDate = format(
			parseISO(
				(type.work ? startDate : type.certificates ? date : endDate) ?? '',
			),
			'MMM yyyy',
		),
		...experience
	}) => {
		const alt = experience.image.split('.').reverse().pop() + ' Logo.';
		const src = Logo(experience.image);
		return (<div class="timeline__item">
			<time class="timeline__duration" datetime={eventDate}>{eventDate}</time> {
				experience.image && <div class="timeline__logo">
					<Image {src} {alt} width="42" height="42" />
				</div> || <div class="timeline__point"></div>
			}
			<div class="timeline__content">
				<div style="width: 100%">
					<h3 class="timeline__header">
						{type.education ? experience.institution : experience.name}
					</h3>
					<div class="timeline__body"> {
						type.work && <h4 class="timeline__sub">{experience.position}</h4>
						<>
							{experience.useSummary && <p>{experience.summary}</p>}
							{experience.highlights && <ul class="timeline__responsabilities-achievements [ flow ]"> {
								experience?.highlights?.map((highlight) =>
									<li>
										{highlight}
									</li>
								)}
							</ul>
							}
						</> ||
						type.certificates && <p class="timeline__issuer">
							{experience.issuer}
						</p> ||
						type.education && <h4 class="timeline__sub">{experience.area}</h4>
						<p class="timeline__degree">
							{experience.studyType}
						</p>
					}
					</div>
				</div>
				<span class="timeline__icon" data-icon={type.icon} />
			</div>
		</div>)
	})
}
</div>

<style lang="scss">
	@use '@/styles/base/root';
	@use '@/styles/base/typography' as *;

	.timeline {
		--logo-size: 42px;
		--image-size: var(--xlarge-space);
		--flow-space: var(--small-space);
		// --flow-space: var(--xsmall-space);

		padding-top: 2px;
		position: relative;
		padding-inline-start: var(--gigentic-space);
		// width: 90%;

		&__section-heading {
			@extend .heading;
			position: relative;
			// margin-inline: var(--xsmall-space);
			// background-color: var(--bg-color);
			margin-block-start: calc(-1 * var(--default-space));
			// margin-block-end: 1em;
			padding-block-start: var(--default-space);
			margin-inline-end: var(--large-space);
			border-bottom: 2px solid var(--primary-color);

			&[data-sr-only] {
				position: absolute;
				width: 1px;
				height: 1px;
				padding: 0;
				margin: -1px;
				overflow: hidden;
				clip: rect(0, 0, 0, 0);
				white-space: nowrap;
				border-width: 0;
			}
		}

		&::before {
			content: '';
			position: absolute;
			top: 0;
			height: 50%;
			width: 2px;
			border-left: 1px solid var(--primary-color);
		}

		&__item {
			position: relative;
			cursor: pointer;
			margin: var(--default-space) var(--xlarge-space);
			padding: var(--default-space) var(--medium-space);
			box-shadow: 0px 3px 6px -1px rgba(0, 0, 0, 0.2);
			border-radius: var(--xsmall-space);
			transition: all 500ms;

			&:hover {
				box-shadow: 1px 6px 16px -1px rgba(0, 0, 0, 0.1);

				.timeline__logo {
					border: 2px solid var(--accent-color);
				}
			}

			&:where(:not(:last-child)) {
				&::after {
					content: '';
					width: 1px;
					height: 100%;
					margin: var(--huge-space) 0;
					background: var(--primary-color);
					position: absolute;
					top: 0;
					// transform: translateY(-5%);
					left: -2rem;
					z-index: -1;
				}
			}

			// &::after,
			// &:first-child::after {
			// 	content: '';
			// 	width: 1px;
			// 	height: 100%;
			// 	margin: var(--huge-space) 0;
			// 	background: var(--primary-color);
			// 	position: absolute;
			// 	top: 0;
			// 	// transform: translateY(-50%);
			// 	left: -2rem;
			// 	z-index: -1;
			// }
		}

		&__duration {
			font-weight: 500;
			position: absolute;
			top: 0;
			left: -85px;
			line-height: 1.2;
			height: 20px;
			width: 10%;
			transform: translateX(-25%);
			text-align: center;

			// @include respond-to(sm) {
			// 	position: absolute;
			// 	top: 0;
			// 	left: -85px;
			// 	line-height: 1.2;
			// 	height: 20px;
			// 	width: 10%;
			// 	transform: translateX(-25%);
			// 	text-align: right;
			// }
		}

		&__logo {
			box-sizing: content-box;
			position: absolute;
			top: 0;
			left: calc(-1 * var(--image-size));
			width: var(--logo-size);
			height: var(--logo-size);
			display: flex;
			align-items: center;
			background: #fff;
			border: 2px solid var(--primary-color);
			border-radius: 50%;
			transform: translate(-50%, 40%);
			transition: all 500ms;
			overflow: hidden;

			// img {
			// 	display: block;
			// 	width: var(--image-size);
			// 	height: var(--image-size);
			// 	transform: translate(28%, 28%);
			// }

			// img[alt='70-486 Logo'] {
			// 	transform: scale(2) translate(0.3rem, 11%);
			// }

			// img[alt='MitraTech+Quovant'] {
			// 	transform: scale(1.6) translate(18%, 18%);
			// }

			// img[alt='MTSU'] {
			// 	width: calc(var(--logo-size) - 0.7px);
			// 	transform: scale(0.9) translate(4%, 32%);
			// }

			// :global(img[alt='MTSU Logo.']) {
			// 	// top: var(--xsmall-space);
			// 	// padding-top: 0.1rem;
			// }

			// @include respond-to(sm) {
			// 	transform: translate(-50%, 15%);
			// }
		}

		&__point {
			--point-size: calc(var(--logo-size) / 3);
			--point-radius: calc(var(--point-size) / 2);

			box-sizing: content-box;
			position: absolute;
			top: 0;
			left: calc(-1 * var(--point-radius));
			width: var(--point-size);
			height: var(--point-size);
			background: var(--primary-color);
			border: 2px solid var(--primary-color);
			border-radius: 50%;
			transform: translate(-50%, 40%);
			transition: all 500ms;
			overflow: hidden;
		}

		&__content {
			display: flex;
			flex-flow: row;
			flex-direction: row-reverse;
			justify-content: flex-start;
			margin-inline: var(--small-space);
			// [data-type='professional'] & {
			// }
		}

		&__header {
			// margin: 0;
			// padding: 0;
			font-family: var(--secondary-ff);
			// font-family: "Pacifico", cursive;
			// line-height: 1.5;
			font-size: 0.99rem;
			font-weight: 600;
			color: var(--accent-color);
			border-bottom: 1px solid var(--primary-color);
			width: 100%;
		}

		&__sub {
			// margin: 0;
			// padding: 0;
			// line-height: 2;
			font-weight: 500;
			// font-size: 0.75rem;
		}

		&__icon {
			position: absolute;
		}

		&__body {
			margin: 0 var(--tiny-space);
		}

		&__responsabilities-achievements {
			display: grid;
			padding-inline-start: var(--medium-space);
			padding-block-start: var(--flow-space);

			> li {
				max-width: 77ch;
				padding-inline-start: var(--medium-space);
				&::marker {
					content: '\2192';
					// font-size: unset;
				}
			}

			// > li {
			// 	&::marker {
			// 		// content: '\203a  ';
			// 		// color: var(--accent-color);
			// 		// font-size: 20px;
			// 	}
			// }
		}

		&__issuer {
			margin-block-end: 0;
		}

		&__degree {
			margin-block: 0;
		}

		// @include respond-to(sm) {
		// 	--flow-space: var(--small-space);
		// }
	}
</style>
